
exports.up = function (knex) {
  return knex.schema.alterTable('users', tbl => {
    tbl.text('name')
    tbl.text('phoneNumber')
    tbl.text('email')
      .notNullable()
      .defaultTo('noemail@foodtruck.tracker')
  })
    .createTable('cuisines', tbl => {
      tbl.increments('id')
      tbl.text('name')
        .notNullable()
        .unique()
    })
    .createTable('photos', tbl => {
      tbl.increments('id')
      tbl.text('url')
        .unique()
        .notNullable()
      tbl.integer('userId')
        .notNullable()
    })
    .createTable('trucks', tbl => {
      tbl.increments('id')
      tbl.text('name')
        .notNullable()
      tbl.integer('userId')
        .notNullable()
        .references('id')
        .inTable('users')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.text('location')
        .notNullable()
      tbl.dateTime('departureTime')
        .notNullable()
      tbl.integer('cuisineId')
        .notNullable()
        .references('id')
        .inTable('cuisines')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('photoId')
        .references('id')
        .inTable('photos')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
    })
    .createTable('favorites', tbl => {
      tbl.integer('truckId')
        .notNullable()
        .references('id')
        .inTable('trucks')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('userId')
        .notNullable()
        .references('id')
        .inTable('users')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')

      tbl.primary(['truckId', 'userId'])
    })
    .createTable('truckRatings', tbl => {
      tbl.increments('id')
      tbl.integer('truckId')
        .notNullable()
        .references('id')
        .inTable('trucks')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('userId')
        .notNullable()
        .references('id')
        .inTable('users')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('rating')
        .notNullable()
    })
    .createTable('menuItems', tbl => {
      tbl.increments('id')
      tbl.text('name')
        .unique()
        .notNullable()
    })
    .createTable('trucks-menuItems', tbl => {
      tbl.integer('truckId')
        .notNullable()
        .references('id')
        .inTable('trucks')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('menuItemId')
        .notNullable()
        .references('id')
        .inTable('menuItems')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.decimal('price')
        .notNullable()
      tbl.text('description')

      tbl.primary(['truckId', 'menuItemId'])
    })
    .createTable('menuItems-photos', tbl => {
      tbl.integer('menuItemId')
        .notNullable()
        .references('id')
        .inTable('menuItems')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('photoId')
        .notNullable()
        .references('id')
        .inTable('photos')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')

      tbl.primary(['menuItemId', 'photoId'])
    })
    .createTable('menuItemRatings', tbl => {
      tbl.integer('userId')
        .notNullable()
        .references('id')
        .inTable('users')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('truckId')
        .notNullable()
        .references('id')
        .inTable('trucks')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')
      tbl.integer('rating')
        .notNullable()
      tbl.integer('menuItemId')
        .notNullable()
        .references('id')
        .inTable('menuItems')
        .onDelete('CASCADE')
        .onUpdate('CASCADE')

      tbl.primary(['userId', 'truckId', 'menuItemId'])
    })
};

exports.down = function (knex) {
  return knex.schema.dropTable('menuItemRatings')
    .dropTable('menuItems-photos')
    .dropTable('trucks-menuItems')
    .dropTable('menuItems')
    .dropTable('truckRatings')
    .dropTable('favorites')
    .dropTable('trucks')
    .dropTable('photos')
    .dropTable('cuisines')
    .alterTable('users', tbl => {
      tbl.dropColumn('name')
      tbl.dropColumn('phoneNumber')
      tbl.dropColumn('email')
    })
};
